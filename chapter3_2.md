# 3.2. Модуль управления пользователями

Модуль управления пользователями реализован в файлах `database.py` и `ui/add_user_dialog.py` и обеспечивает полный цикл работы с биометрическими данными: от регистрации новых пользователей до их удаления из системы. Ключевой особенностью реализации является интеграция процесса захвата биометрических данных непосредственно в интерфейс добавления пользователя.

## Процесс добавления пользователей

Диалог добавления пользователя `AddUserDialog` построен на адаптивной архитектуре с использованием `QSplitter`, что позволяет системе корректно работать на различных разрешениях экрана. Левая панель содержит форму ввода персональных данных, а правая - систему захвата биометрических характеристик.

Форма персональных данных включает обязательные поля идентификатора пользователя и полного имени. Валидация данных выполняется в реальном времени с блокировкой кнопки сохранения при незаполненных обязательных полях. Система предотвращает добавление пользователей с дублирующимися идентификаторами через проверку уникальности на уровне базы данных.

Система захвата биометрических данных реализована через вкладочный интерфейс с двумя режимами работы: загрузка изображения из файла и съемка с камеры. Каждый режим включает собственную логику обработки и валидации биометрических данных.

При загрузке файла система поддерживает форматы PNG, JPG и JPEG. Метод `process_image_file` выполняет полную проверку загруженного изображения: наличие лица, отсутствие множественных лиц и качество биометрических характеристик. Обработка включает преобразование BGR в RGB формат для совместимости с библиотекой face_recognition.

## Интеграция с камерой для регистрации

Режим съемки с камеры использует отдельный поток `CameraThread` для предотвращения блокировки пользовательского интерфейса. Поток обеспечивает непрерывный захват кадров и автоматическое обнаружение лиц в реальном времени с визуальной индикацией результатов.

Класс `CameraThread` инициализирует камеру с попыткой использования DirectShow backend в Windows для повышения стабильности соединения. При недоступности DirectShow система автоматически переключается на универсальный backend. Буферизация ограничена одним кадром для минимизации задержек отображения.

Система статусов информирует пользователя о состоянии процесса регистрации: "Поиск лица", "Лицо найдено", "Несколько лиц" с соответствующей цветовой индикацией. Кнопка захвата активируется только при обнаружении ровно одного лица в кадре, что предотвращает создание некачественных биометрических образцов.

Функция `capture_face` создает временный файл с уникальным именем на основе временной метки и сохраняет кадр с выделенной областью лица зеленой рамкой. Биометрический шаблон извлекается из полного разрешения кадра, а координаты лица масштабируются обратно после обнаружения на уменьшенном изображении.

## Обработка биометрических шаблонов

Извлечение биометрических характеристик выполняется через `face_recognition.face_encodings`, который возвращает 128-элементный вектор численных характеристик лица. Система проверяет успешность создания кодировки перед сохранением данных пользователя.

Метод `add_user` в классе `Database` выполняет атомарное добавление пользователя с обработкой ошибок уникальности. Биометрический шаблон сериализуется в JSON формат для хранения в SQLite, что обеспечивает читаемость данных и простоту отладки.

Сохранение фотографий пользователей выполняется в директорию `USER_PHOTOS_DIR` с именами файлов, включающими идентификатор пользователя и временную метку. Это предотвращает конфликты имен и обеспечивает уникальность файлов при множественных регистрациях.

Система автоматически обновляет кэш движка распознавания при добавлении нового пользователя через вызов `reload_face_encodings()`. Это гарантирует немедленную доступность новых пользователей для распознавания без перезапуска системы.

## Управление существующими пользователями

Главное окно системы отображает список пользователей в таблице `users_table` с колонками идентификатора, имени, email, даты создания и кнопки удаления. Метод `update_users_table` загружает данные из базы и форматирует даты для читаемого отображения.

Функция удаления пользователей реализована как мягкое удаление через установку флага `is_active = 0` вместо физического удаления записи. Это сохраняет историю для аудита при необходимости восстановления данных.

Каждая строка таблицы содержит кнопку удаления с лямбда-функцией, передающей идентификатор пользователя в метод `delete_user`. Система требует подтверждения удаления через `QMessageBox.question` для предотвращения случайных операций.

При удалении пользователя система автоматически обновляет кэш распознавания через `remove_face()` и перезагружает таблицу пользователей для отражения изменений. Файл фотографии пользователя остается в файловой системе для возможного восстановления.

## Валидация и контроль качества

Система включает многоуровневую валидацию биометрических данных. Проверка на уровне библиотеки face_recognition отклоняет изображения без обнаруженных лиц или с неопределенными биометрическими характеристиками.

Контроль множественных лиц предотвращает регистрацию неоднозначных биометрических образцов. Система отображает предупреждение при обнаружении нескольких лиц и требует изоляции одного пользователя в кадре.

Проверка качества изображения анализирует размер обнаруженного лица и общие характеристики изображения. Слишком маленькие или размытые лица отклоняются с соответствующими сообщениями пользователю.

Временные файлы, создаваемые при съемке с камеры, автоматически удаляются при закрытии диалога или отмене операции через переопределенные методы `closeEvent` и `reject`. Это предотвращает накопление временных файлов в системе.

Такая реализация модуля управления пользователями обеспечивает надежную регистрацию биометрических данных с контролем качества и создает основу для интеграции дополнительных проверок безопасности в процесс регистрации пользователей.