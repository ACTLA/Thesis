# 2.3. Движок распознавания лиц с кэшированием

Движок распознавания лиц, реализованный в файле `face_recognition_engine.py`, представляет собой центральный компонент системы, отвечающий за идентификацию пользователей по их биометрическим характеристикам. Система построена на современных алгоритмах глубокого обучения с оптимизациями для работы в реальном времени.

## Архитектура движка распознавания

Класс `FaceRecognitionEngine` инкапсулирует всю логику обработки биометрических данных и построен по принципу конвейерной обработки. Каждый кадр проходит через последовательность этапов: обнаружение лиц, извлечение признаков, сравнение с базой данных и принятие решения об идентификации.

Основой алгоритма является библиотека face_recognition, которая использует предварительно обученную модель ResNet для извлечения 128-мерных векторов признаков лица. Эти векторы служат уникальными биометрическими подписями пользователей и обеспечивают высокую точность сравнения.

```python
class FaceRecognitionEngine:
    def __init__(self, database):
        self.db = database
        self._cached_users = []
        self._cache_lock = threading.RLock()
        self._last_recognitions = {}
        self._frame_counter = 0
        
        self.load_known_faces()
```

Система кэширования биометрических шаблонов в оперативной памяти значительно ускоряет процесс распознавания. При инициализации движка все шаблоны зарегистрированных пользователей загружаются из базы данных и сохраняются в структурах данных, оптимизированных для быстрого поиска.

## Процесс обнаружения лиц

Обнаружение лиц выполняется с использованием алгоритма HOG (Histogram of Oriented Gradients), который обеспечивает хороший баланс между скоростью и точностью. Для ускорения обработки кадры предварительно масштабируются с коэффициентом 0.25, что в четыре раза уменьшает объем данных для анализа.

```python
def _detect_faces(self, frame):
    small_frame = cv2.resize(frame, (0, 0), fx=RESIZE_SCALE, fy=RESIZE_SCALE)
    rgb_frame = cv2.cvtColor(small_frame, cv2.COLOR_BGR2RGB)
    
    face_locations = face_recognition.face_locations(rgb_frame, model='hog')
    face_encodings = face_recognition.face_encodings(rgb_frame, face_locations)
    
    # Масштабирование координат обратно
    scaled_locations = []
    for top, right, bottom, left in face_locations:
        scaled_location = (
            int(top / RESIZE_SCALE),
            int(right / RESIZE_SCALE),
            int(bottom / RESIZE_SCALE),
            int(left / RESIZE_SCALE)
        )
        scaled_locations.append(scaled_location)
```

Координаты обнаруженных лиц масштабируются обратно для корректного отображения на исходном изображении. Это позволяет точно выделить области лиц на видеопотоке для визуальной обратной связи пользователю.

## Сравнение биометрических шаблонов

Идентификация пользователя происходит путем сравнения извлеченного биометрического шаблона с предварительно сохраненными шаблонами известных пользователей. Система использует евклидово расстояние между векторами признаков для определения степени похожести лиц.

Порог принятия решения настраивается через константу `FACE_RECOGNITION_TOLERANCE`, которая определяет максимальное расстояние между шаблонами для положительной идентификации. Значение 0.6 обеспечивает хороший баланс между точностью распознавания и количеством ложных срабатываний.

```python
def _recognize_face(self, detection):
    if not self.known_encodings:
        return None
    
    distances = face_recognition.face_distance(
        self.known_encodings, 
        detection.encoding
    )
    
    min_distance_idx = np.argmin(distances)
    min_distance = distances[min_distance_idx]
    
    if min_distance <= FACE_RECOGNITION_TOLERANCE:
        user = self.known_users[min_distance_idx]
        confidence = 1.0 - min_distance
        
        return FaceMatch(
            user_id=user['id'],
            user_code=user['user_id'],
            full_name=user['full_name'],
            confidence=confidence,
            face_location=detection.location,
            timestamp=detection.timestamp
        )
```

Уровень уверенности в распознавании вычисляется как инверсия нормализованного расстояния, что дает интуитивно понятную метрику от 0 до 1, где 1 означает полное совпадение.

## Оптимизация производительности

Система применяет несколько стратегий оптимизации для обеспечения работы в реальном времени. Основной метод - пропуск кадров при высокой частоте видеопотока. Обработка выполняется только для каждого третьего кадра, что снижает вычислительную нагрузку без существенного влияния на качество распознавания.

Механизм предотвращения повторных срабатываний устанавливает временную задержку после успешного распознавания пользователя. В течение периода "охлаждения" повторные распознавания того же лица игнорируются, что предотвращает спам в журналах и улучшает пользовательский опыт.

```python
def _should_process_recognition(self, match):
    user_id = match.user_id
    current_time = match.timestamp
    
    if user_id in self._last_recognitions:
        last_time = self._last_recognitions[user_id]
        if current_time - last_time < RECOGNITION_COOLDOWN:
            return False
    
    return True
```

Кэширование биометрических данных включает автоматическое управление размером кэша для предотвращения переполнения памяти при большом количестве пользователей. Система поддерживает ограниченное количество записей и удаляет наиболее старые при превышении лимита.

## Управление кэшем и синхронизация

Загрузка биометрических шаблонов из базы данных происходит при инициализации системы и может быть выполнена повторно при изменении данных пользователей. Система проверяет время модификации кэша и автоматически обновляет данные при необходимости.

Файловое кэширование через модуль pickle обеспечивает быстрый запуск системы при повторных сеансах работы. Кэш сохраняется на диск после каждого обновления и загружается при следующем запуске, если он не устарел.

Потокобезопасность кэша обеспечивается через использование блокировок при доступе к общим структурам данных. Это позволяет безопасно добавлять новых пользователей и обновлять кэш во время работы системы распознавания.

Статистика работы движка включает количество обработанных кадров, успешных распознаваний и среднее время обработки. Эти метрики используются для мониторинга производительности и выявления потенциальных проблем в работе системы.

Такая реализация движка распознавания обеспечивает эффективную и надежную идентификацию пользователей, создавая прочную основу для интеграции дополнительных функций безопасности в будущих версиях системы.