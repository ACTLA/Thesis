# 3.3. Система аутентификации администраторов

Система аутентификации администраторов реализована в файлах `ui/login_window.py` и методах класса `Database` для обеспечения безопасного доступа к функциям управления системой. Реализация включает хеширование паролей с солью, защиту от атак перебора и пользовательский интерфейс с элементами безопасности.

## Архитектура окна входа

Класс `LoginWindow` реализует адаптивный интерфейс входа с фиксированными размерами 500x600 пикселей для обеспечения предсказуемого отображения на различных устройствах. Окно автоматически центрируется на экране через метод `center_on_screen()`, использующий `QDesktopWidget` для определения геометрии экрана.

Интерфейс построен на вертикальном layout с компонентами аутентификации: полями ввода имени пользователя и пароля, чекбоксом запоминания учетных данных и кнопкой входа. Поля ввода имеют минимальную высоту 50 пикселей и стилизованы с использованием CSS-подобного синтаксиса PyQt5.

Поле пароля использует `QLineEdit.Password` режим для скрытия вводимых символов. Система поддерживает вход по клавише Enter через подключение сигнала `returnPressed` к методу `handle_login` для обоих полей ввода.

Автоматическое заполнение полей значениями "admin" и "admin123" реализовано для упрощения первоначального доступа к системе. Эти данные устанавливаются в конструкторе класса после создания элементов интерфейса.

## Процесс аутентификации

Метод `handle_login` выполняет базовую валидацию входных данных перед обращением к базе данных. Система проверяет заполненность обоих полей и отображает предупреждение через `QMessageBox.warning` при обнаружении пустых значений.

Блокировка пользовательского интерфейса во время проверки предотвращает множественные попытки входа. Кнопка входа деактивируется методом `setEnabled(False)`, а текст изменяется на "Проверка..." для информирования пользователя о выполняющемся процессе.

Вызов `authenticate_admin` из класса `Database` выполняет проверку учетных данных с возвращением словаря данных администратора при успешной аутентификации или `None` при неудаче. Результат обрабатывается условным оператором для определения дальнейших действий.

Успешная аутентификация приводит к эмиссии сигнала `login_successful` с передачей данных администратора и закрытию окна входа. Неудачная попытка очищает поле пароля, возвращает фокус на это поле и отображает сообщение об ошибке.

## Реализация безопасного хеширования

Метод `_hash_password` в классе `Database` использует PBKDF2 (Password-Based Key Derivation Function 2) с SHA-256 для создания стойких хешей паролей. Функция принимает пароль и соль, выполняя 100000 итераций хеширования для защиты от атак перебора.

Генерация соли выполняется через `secrets.token_hex(32)`, создающий криптографически стойкую случайную строку длиной 64 символа. Уникальная соль для каждого администратора предотвращает атаки по радужным таблицам.

Создание администратора по умолчанию в методе `_create_default_admin` проверяет существование учетной записи "admin" перед созданием новой записи. Это предотвращает дублирование при множественных запусках системы.

Аутентификация в методе `authenticate_admin` включает получение сохраненной соли и хеша пароля из базы данных, создание хеша введенного пароля с той же солью и сравнение результатов. Использование временно-константного сравнения предотвращает атаки по времени выполнения.

## Управление сессиями

Успешная аутентификация обновляет поле `last_login` в таблице администраторов текущей временной меткой через `datetime.now()`. Это создает аудиторский след входов в систему для анализа безопасности.

Возвращаемый словарь данных администратора включает только необходимую информацию: идентификатор, имя пользователя и email. Чувствительные данные, такие как хеш пароля и соль, исключаются из результата для ограничения их распространения в приложении.

Проверка активности учетной записи через поле `is_active` позволяет деактивировать администраторов без удаления их данных. Неактивные учетные записи отклоняются на этапе аутентификации с возвращением `None`.

Передача данных администратора в главное окно через сигнал `login_successful` обеспечивает доступность информации о текущем пользователе для функций аудита и управления правами доступа.

## Визуальные элементы безопасности

Анимация встряхивания при неудачном входе реализована через `QPropertyAnimation` с изменением позиции окна. Анимация выполняется три раза с амплитудой 10 пикселей для привлечения внимания к ошибке аутентификации.

Стилизация полей ввода включает изменение цвета рамки при получении фокуса с `#667eea` для индикации активного элемента. Поля имеют скругленные углы с радиусом 10 пикселей и внутренние отступы 12 пикселей для современного внешнего вида.

Кнопка входа стилизована с градиентными эффектами при наведении курсора и нажатии. Цвет фона изменяется с основного `PRIMARY_COLOR` на более темные оттенки для визуальной обратной связи пользователю.

Обработка клавиши Escape через переопределенный метод `keyPressEvent` позволяет закрыть окно входа без аутентификации. Это обеспечивает стандартное поведение диалоговых окон в настольных приложениях.

## Интеграция с главным окном

Сигнал `login_successful` подключается к методу `on_login_success` в классе `FaceRecognitionApp` для создания и отображения главного окна системы. Данные администратора передаются в конструктор `MainWindow` для персонализации интерфейса.

Закрытие окна входа происходит автоматически при успешной аутентификации через вызов `self.close()`. Это предотвращает накопление неиспользуемых окон и освобождает системные ресурсы.

Обработка неудачной аутентификации включает очистку поля пароля методом `clear()` и установку фокуса обратно на это поле для удобства повторного ввода. Сообщение об ошибке отображается через `QMessageBox.critical` с понятным текстом.

Такая реализация системы аутентификации обеспечивает базовую защиту доступа к административным функциям и создает основу для интеграции многофакторной аутентификации и расширенных механизмов безопасности в будущих версиях системы.