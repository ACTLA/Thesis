# 3.4. Журналирование операций системы

Система журналирования реализована на двух уровнях для обеспечения комплексной регистрации всех операций: журналы событий распознавания в базе данных SQLite и системные журналы через стандартный модуль logging Python. Такой подход обеспечивает детальную фиксацию работы системы для анализа производительности и выявления проблем.

## Журналирование событий распознавания

Таблица `recognition_logs` в базе данных фиксирует каждое событие идентификации пользователя с полной контекстной информацией. Структура записи включает ссылку на идентифицированного пользователя, точную временную метку, уровень уверенности алгоритма и тип результата распознавания.

```python
def add_recognition_log(self, user_id: int, confidence: float, recognition_type: str = 'SUCCESS') -> Optional[int]:
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO recognition_logs (user_id, confidence, recognition_type)
                VALUES (?, ?, ?)
            ''', (user_id, confidence, recognition_type))
            
            log_id = cursor.lastrowid
            conn.commit()
            return log_id
    except Exception as e:
        return None
```

Вызов журналирования происходит в методе `on_face_recognized` виджета распознавания лиц сразу после успешной идентификации и получения данных пользователя из базы. Система передает идентификатор пользователя, численное значение уверенности от 0.0 до 1.0 и константу типа события.

Изоляция ошибок журналирования от основного процесса распознавания обеспечивается через отдельные блоки обработки исключений. Неудачная запись в журнал регистрируется в системном журнале, но не прерывает работу алгоритмов идентификации.

## Отображение журналов в интерфейсе

Метод `get_recognition_report` создает детализированные отчеты о событиях распознавания с объединением информации из таблиц пользователей и журналов. SQL запрос включает полные имена пользователей и их идентификаторы для читаемого отображения.

```python
def get_recognition_report(self, limit: int = 100) -> List[Dict]:
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT r.*, u.full_name, u.user_id as user_code
                FROM recognition_logs r
                JOIN users u ON r.user_id = u.id
                ORDER BY r.timestamp DESC
                LIMIT ?
            ''', (limit,))
            
            records = cursor.fetchall()
            return [dict(rec) for rec in records]
    except Exception as e:
        return []
```

Главное окно системы отображает последние события в таблице через метод `update_recent_recognitions`, который форматирует временные метки и показатели уверенности в процентном виде. Таблица автоматически обновляется при переключении на панель управления.

Страница отчетов содержит расширенную таблицу с большим количеством записей для детального анализа активности системы. Сортировка по убыванию времени обеспечивает отображение самых свежих событий в верхней части списка.

## Системное журналирование

Конфигурация системного журналирования в функции `setup_logging` создает иерархическую структуру с записью в файл и консольный вывод. Ротирующий файловый обработчик ограничивает размер каждого файла журнала 10 мегабайтами с сохранением пяти резервных копий.

```python
def setup_logging():
    from logging.handlers import RotatingFileHandler
    
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, LOG_LEVEL, logging.INFO))
    
    # Форматтер для записей
    formatter = logging.Formatter(LOG_FORMAT)
    
    # Файловый обработчик с ротацией
    log_file = LOGS_DIR / 'face_recognition.log'
    file_handler = RotatingFileHandler(
        log_file,
        maxBytes=LOG_MAX_BYTES,
        backupCount=LOG_BACKUP_COUNT,
        encoding='utf-8'
    )
    file_handler.setFormatter(formatter)
    root_logger.addHandler(file_handler)
```

Уровень детализации журналирования контролируется через константу `LOG_LEVEL` в конфигурации системы. Формат записей включает временную метку, имя модуля, уровень важности сообщения и текстовое описание события.

Журналы различных компонентов системы фиксируют специфические события их работы. Менеджер камеры регистрирует инициализацию оборудования, ошибки подключения и изменения состояния. Движок распознавания записывает статистику обработки и результаты загрузки биометрических шаблонов.

## Статистические данные и агрегация

Система включает методы для получения агрегированной статистики событий распознавания. Функции `get_today_recognition_count` и `get_unique_users_today` используют SQL агрегатные функции для быстрого подсчета событий за текущий день.

```python
def get_today_recognition_count(self) -> int:
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT COUNT(*) 
                FROM recognition_logs 
                WHERE DATE(timestamp) = DATE('now')
            ''')
            return cursor.fetchone()[0]
    except Exception as e:
        return 0

def get_unique_users_today(self) -> int:
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT COUNT(DISTINCT user_id) 
                FROM recognition_logs 
                WHERE DATE(timestamp) = DATE('now')
            ''')
            return cursor.fetchone()[0]
    except Exception as e:
        return 0
```

Карточки статистики в панели управления отображают ключевые показатели работы системы: общее количество зарегистрированных пользователей, количество распознаваний за день и количество уникальных пользователей. Визуальное оформление включает иконки и цветовую индикацию для быстрого восприятия информации.

## Управление размером журналов

Автоматическая ротация системных журналов предотвращает неконтролируемый рост размера файлов при длительной эксплуатации системы. При достижении максимального размера создается новый файл журнала, а предыдущие архивируются с численными суффиксами.

Журналы базы данных требуют ручного управления размером, поскольку SQLite не имеет встроенных механизмов автоматического архивирования. При длительной работе системы таблица `recognition_logs` может значительно увеличиться в размере.

Права доступа к файлам журналов наследуются от настроек операционной системы. В продуктивной среде рекомендуется настройка ограниченных прав доступа для защиты журналов от несанкционированного просмотра или изменения.

## Анализ и мониторинг активности

Текущая реализация не включает автоматизированный анализ журналов для выявления аномалий или подозрительных паттернов активности. Анализ выполняется вручную через интерфейс отчетов или прямые SQL запросы к базе данных.

Индикаторы состояния в пользовательском интерфейсе предоставляют базовую информацию о работе ключевых компонентов: статус подключения камеры, результаты последних распознаваний и общую статистику системы.

Экспорт данных журналов в внешние форматы не реализован в текущей версии. Доступ к детальным данным возможен через SQL запросы к базе данных или чтение текстовых файлов системных журналов.

Такая реализация журналирования обеспечивает базовую регистрацию всех операций системы и создает фундамент для интеграции расширенных механизмов аудита безопасности и автоматического анализа аномалий в будущих версиях системы.